local M = {}

local function exec(cmd)
  local handle = io.popen(cmd)
  local result = handle:read("*a")
  handle:close()
  return result
end

function M.play_pause()
  exec("strawberry -t")
end

function M.next()
  exec("strawberry -f")
end

function M.prev()
  exec("strawberry -r")
end

local function get_metadata()
  local cmd = [[
  dbus-send --print-reply --dest=org.mpris.MediaPlayer2.strawberry \
  /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get \
  string:'org.mpris.MediaPlayer2.Player' string:'Metadata'
  ]]

  local result = exec(cmd)

  local title = result:match('string "xesam:title"%s+variant%s+string "([^"]+)"')
  local artist = result:match('string "xesam:artist"%s+variant%s+array %[%s+string "([^"]+)"')
  local album = result:match('string "xesam:album"%s+variant%s+string "([^"]+)"')
  local url = result:match('string "file://([^"]+%.mp3)"')

  return {
    title = title or "Unknown Title",
    artist = artist or "Unknown Artist",
    album = album or "Unknown Album",
    url = url
  }
end

local function get_playlist()
  local sqlite_path = os.getenv("HOME") .. "/.local/share/strawberry/strawberry.db"
  local query = [[
    SELECT s.title
    FROM playlist_items AS p
    JOIN songs AS s ON p.collection_id = s.rowid
    WHERE p.playlist = 1;
  ]]

  local cmd = string.format([[sqlite3 "%s" "%s"]], sqlite_path, query)
  local output = vim.fn.systemlist(cmd)

  local playlist = {}
  for i, title in ipairs(output) do
    table.insert(playlist, {
      index = i,
      title = title
    })
  end
  return playlist
end

function M.show_status()
  local meta = get_metadata()
  local playlist = get_playlist()
  local playlist_lines = {}

  for i, track in ipairs(playlist) do
    local marker = (track.title == meta.title) and "> " or "  "
    table.insert(playlist_lines, string.format("%s%02d. %s", marker, i, track.title))
  end

  local info_lines = {
    "ðŸŽµ Now Playing:",
    "  Track:  " .. meta.title,
    "  Artist: " .. meta.artist,
    "  Album: " .. meta.album,
  }

  local max_info_width = 40
  local height = math.max(#info_lines, #playlist_lines) + 2
  local width = max_info_width + 40

  local buf = vim.api.nvim_create_buf(false, true)
  local combined_lines = {}
  for i = 1, height - 2 do
    local left = info_lines[i] or ""
    local right = playlist_lines[i] or ""
    table.insert(combined_lines, string.format("%-" .. max_info_width .. "s â”‚ %s", left, right))
  end

  vim.api.nvim_buf_set_lines(buf, 0, -1, false, combined_lines)

  vim.api.nvim_open_win(buf, true, {
    relative = "editor",
    width = width,
    height = height,
    col = (vim.o.columns - width) / 2,
    row = (vim.o.lines - height) / 2,
    style = "minimal",
    border = "rounded",
  })

  vim.api.nvim_buf_set_keymap(buf, "n", "q", ":bd!<CR>", { noremap = true, silent = true })
end

return M

